# 블루 아카이브 자동화 테스트 사용 가이드

본 문서는 `gui_test_runner.py`를 기준으로 각 테스트 케이스가 **실제 게임 화면(GUI)** 에서 어떤 흐름으로 동작하며, 사용자가 무엇을 준비하고 어떤 결과를 확인해야 하는지를 설명합니다.

---

## 공통 실행 환경

- 해상도: **2560x1440 (필수)**
- 실행 대상: **Live 빌드 클라이언트**
- 입력 방식: 마우스 / 키보드 자동 입력
- 검증 방식: 템플릿 매칭 기반 화면 인식

⚠️ 해상도, UI 스케일, 창 모드 변경 시 테스트 실패 가능

---

## 테스트 실행 방법

```bash
BlueArchiveAutoTest.exe 실행
```
![alt text](image.png)
- 테스트는 원하는 테스트를 선택하여 실행합니다
- 여러 테스트를 선택하여 실행할 수 있으나 대기 시간 싱크가 맞지 않아 권하지 않습니다.
- 실패 발생 시 해당 TC에서 즉시 중단됩니다 (Fail Fast)
- 각 단계별 스크린샷 및 로그 자동 저장됩니다
![alt text](image-10.png)
---

## TC-001: 기본 모듈 테스트
### 테스트 대상
   1. GameController - 마우스/키보드 제어
   2. TemplateMatcher - 이미지 인식
   3. TestLogger - 결과 로깅

---

## TC-002: 스테이지 진입
![alt text](image-8.png)
### GUI 동작 흐름
   1. 시작 발판 클릭
   2. 편성 화면 전환
   3. 출격 버튼 클릭
   4. 스테이지 맵으로 돌아오는지 확인
   5. 임무 개시 버튼 클릭

### 사용자 확인 포인트
- 스테이지 첫 진입 후 해당 테스트 실행 종료 시 부대 편성이 완료되는지
- 임무 개시 버튼이 클릭 되어 스테이지가 시작되는지
---


---

## TC-003: 발판 이동 및 전투 진입
![alt text](image-9.png)
### GUI 동작 흐름
1. 이동 가능한 발판 클릭
2. 적이 있는 발판이었을 시 전투 진입
3. 비어있는 발판이었을 시 Phase 종료
4. 전투 UI 요소 탐색
   - 하단 전투 UI
   - 스테이지 정보 UI
   - 일시정지 버튼

### 사용자 확인 포인트
- 이동 가능한 발판으로 이동하는지
- 적이 있는 발판이었을 시 전투 화면으로 전환되는지
- 비어있는 발판이었을 시 Phase 종료되는지

### PASS 기준:
```
   1. 이동 가능한 발판 탐색 성공
       - 캐릭터 주변 반경(300px) 내에서 다음 중 하나 이상 발견
            적이 있는 발판 (enemy_tile.png)
            빈 발판 (empty_tile.png)
            
   2. 발판 클릭 성공
      - 선택된 발판에 대해 클릭 입력이 정상적으로 수행됨
      - 클릭 실패 예외(Exception) 발생하지 않음

   3. (보조 조건) 캐릭터 이동 감지 성공
      - 이동 전/후 캐릭터 마커 중심 좌표 비교
      - 이동 거리 ≥ 10px

   4. 전투 진입 UI 다중 조건 검증 성공
      - 전투 UI 요소 중 3개 중 2개 이상이 제한 시간 내 인식됨
```
### FAIL 기준:
```
   1. 이동 가능한 발판을 찾지 못함
      - 캐릭터 주변 반경 내에서
         적 발판 탐지 실패
         빈 발판 탐지 실패
         클릭할 발판이 없는 경우

   2. 발판 클릭 실패
      - controller.click_template()가 False 반환
      - 클릭 중 예외(Exception) 발생

   3. 전투 진입 UI 검증 실패
      - 제한 시간 내 UI 인식 조건 미충족
      - 3개 중 2개 이상 UI를 인식하지 못함
```
### ⚠️ FAIL로 간주하지 않는 항목 (의도적 설계)

다음 항목은 테스트 실패로 처리하지 않습니다.

1. 캐릭터 마커를 찾지 못함
2. 이동 후 캐릭터 위치 변화가 10px 미만
---

## TC-003: 각 학생별 EX 스킬 사용 여부
![alt text](image-3.png)
### GUI 동작 흐름
0. 두 번째 전투 이후에 수행하는것을 권장드립니다.(테스트 도중에 전투가 끝날 수 있습니다.)
1. 전투 시작 후 대기
2. EX 스킬 슬롯 1~3 순차 접근
3. 스킬 버튼을 화면 중앙으로 드래그
4. 사용된 스킬 버튼이 사라졌는지 확인

### 사용자 확인 포인트
- 스킬 버튼이 실제로 드래그되는지
- 사용된 스킬 버튼이 사라졌는지

⚠️ 스킬 발동 성공 여부, 이펙트, 데미지는 검증하지 않습니다

### PASS 기준:
```
   1. Before 단계: 슬롯에서 학생 스킬 버튼 탐지 성공
   2. Action 단계: 스킬 드래그 입력 성공
   3. After 단계: 기존 학생 버튼 소멸 확인
```
### FAIL 기준:
```
   1. 스킬 드래그 실패
   2. 버튼 소멸 실패 (UI 상태 변화 없음)
```
---

## TC-005: 각 전투별 학생 데미지 기록
![alt text](image-4.png)
### GUI 동작 흐름
1. 전투 종료 (전투 결과 화면)
2. 결과 화면에서 통계 버튼 클릭
3. 데미지 리포트 창 대기
4. 학생 아이콘 템플릿 탐색 (최대 6명)

### 사용자 확인 포인트
- 데미지 리포트 UI가 정상적으로 열리는지
- 전투에 참가한 학생 아이콘이 매핑되어 있는지

⚠️ 데미지 수치, 그래프, 순위는 검증 대상이 아닙니다

### PASS 기준:
```
   1. 통계 버튼 클릭
   2. 대미지 기록 창 확인
   3. 학생별 데미지 항목 확인
      - 해당 학생 아이콘 템플릿 탐지 성공
```
### FAIL 기준:
```
   1. 통계 버튼 클릭 실패
   2. 대미지 기록 창 확인 불가
   3. 학생 아이콘 템플릿 존재하지만 탐지 실패
```
---

## TC-006: 보상 획득 UI 검증
![alt text](image-5.png)
### GUI 동작 흐름
0. 마지막 보스 전투 이후에 실행되어야 합니다.
1. 전투 결과 화면 확인
2. 전투 결과 확인 버튼 클릭
3. MISSION COMPLETE 화면 대기
4. 확인 버튼 클릭
5. 보상 아이템 UI 탐색
   - 크레딧 아이콘
   - 활동 보고서 아이콘

### 사용자 확인 포인트
- 보상 화면이 정상적으로 표시되는지
- 보상 아이템 카드 UI가 존재하는지

### PASS 기준:
```
   1. 보상 아이템 UI 확인
      - 보상 결과 화면에 보상 아이템 UI가 매핑되었는지 확인
```
### FAIL 기준:
```
   1. 보상 아이템 UI 확인 실패
      - 템플릿 존재하지만 화면에서 미탐지
```
⚠️ 인벤토리 반영 여부, 수량 증가는 검증하지 않습니다

---
## 테스트 제외 항목

### ❌ TC-004: 스킬 사용 시 코스트 소모량 정상 여부

> 🔎 **요약**
> 전투 중 코스트 값을 OCR로 읽는 시도를 진행했으나, Tesseract OCR의 게임 UI 인식 한계로 40% 정확도에 머물렀습니다.<br/>
   작은 크기의 장식 폰트, 주변 UI 간섭, 동적 이펙트 등으로 인해 요구 정확도(95%)를 충족하지 못했으며,<br/> 템플릿 매칭 방식도 30% 신뢰도로 실패하였습니다.
   **OCR 기술의 한계로 구현 범위에서 제외**.

#### 과제 요구사항
- 스킬 사용 전후 코스트가 올바르게 차감되었는가
- 코스트 부족 시 스킬이 발동하지 않았는가

#### 접근 방법 시도

**시도 1: Tesseract OCR 기반 코스트 읽기**

그레이스케일 변환, 이진화, 노이즈 제거, 스케일 업 등의 전처리와 다중 PSM 모드(7, 8, 6, 13)를 적용했으나 인식 정확도 40%에 머물렀음:

```
실제 코스트: 5
OCR 인식 결과 (5회 시도): None, 8, 5, 3, 5
정확도: 40% (5회 중 2회 정확)
```

**실패 원인:**
- 코스트 숫자 주변 아이콘/장식, 배경 그라디언트 효과
- 작은 숫자 크기 (40-50px)
- 폰트 스타일
- 스킬 이펙트로 인한 화면 번쩍임
- 코스트 변경 애니메이션

**시도 2: 템플릿 매칭 기반 숫자 인식**

2-5까지 4개의 숫자 템플릿 이미지를 준비하여 매칭을 시도했으나, 폰트 렌더링 차이와 화면 밝기/대비 변동으로 인해 30% 신뢰도에 그쳤음:

```
숫자 5 인식 테스트 (10회):
- 5로 인식: 3회 | 2~4로 오인식: 4회 | 인식 실패: 3회
신뢰도: 30%
```

**시도 3: 코스트 변화량 감지**

Before/After 스크린샷을 비교하여 코스트 차감량을 계산하려 했으나, 각 단계의 OCR 실패율(60%)이 누적되어 최종 성공 확률이 16%로 저하되었습니다.\
또한 스킬 사용 후 코스트 업데이트 타이밍(0.5초~2.0초)을 정확히 포착하지 못해 실패하였습니다.

#### 구현 실패 사유

**근본 원인:**
1. **OCR 기술의 한계**
   - Tesseract: 문서용 OCR (게임 UI 최적화 안 됨)
   - 작은 크기 + 장식 폰트 = 인식률 40% 미만
   - 재시도 로직으로도 신뢰도 확보 실패

2. **게임 UI 특성**
   - 코스트 표시 영역이 좁음 (약 50×50px)
   - 주변 장식 요소 다수
   - 실시간 변화하는 배경

3. **동적 환경 방해**
   - 전투 이펙트의 지속적 간섭
   - 코스트 변경 애니메이션
   - 캡처 타이밍 불일치



## 테스트 실패 시 체크리스트

- 해상도가 2560x1440 인지 확인
- UI 스케일 변경 여부 확인
- 게임 언어 설정 변경 여부 확인
- 템플릿 이미지 최신화 여부 확인

---

본 자동화는 **"보인다 / 안 보인다" 수준의 GUI 검증**에 최적화되어 있으며,
게임 내부 상태나 수치 검증은 범위에서 제외됩니다.

