# 블루 아카이브 자동화 테스트 사양서

## 문서 개요

본 문서는 블루 아카이브 Normal 1-4 스테이지 자동화 테스트의 각 검증 항목에 대한 명확한 Pass/Fail 기준을 정의합니다.

**프로젝트**: 블루 아카이브 자동화 테스트
**대상 스테이지**: Normal 1-4
**테스트 방식**: 화면 인식 기반 (Template Matching + OCR)
**작성일**: 2026-01-08

---

## 테스트 케이스 목록

| ID | 테스트 케이스 | 의존성 | 예상 시간 |
|----|--------------|--------|----------|
| TC-001 | 기본 모듈 테스트 | 없음 | 10초 |
| TC-002 | 단계 1-2.5: 스테이지 진입 | 없음 | 30초 |
| TC-003 | 단계 3: 발판 이동 | TC-002 | 20초 |
| TC-004 | 스킬 코스트 OCR 테스트 | 전투 진입 필요 | 15초 |
| TC-005 | 스킬 사용 시스템 테스트 | TC-004 | 30초 |
| TC-006 | 단계 6: 전투 결과 확인 | 전투 종료 필요 | 40초 |
| TC-007 | 전체 플로우 실행 | 없음 | 3-5분 |

---

## TC-001: 기본 모듈 테스트

### 목적
핵심 모듈(TemplateMatcher, GameController, TestLogger)의 기본 동작을 검증합니다.

### 검증 항목

#### 1.1 TemplateMatcher 초기화
- **검증 조건**: TemplateMatcher 객체 생성 성공
- **Pass 기준**:
  - 객체가 정상적으로 생성됨
  - 예외 발생 없음
- **Fail 기준**:
  - ImportError 또는 초기화 예외 발생

#### 1.2 GameController 초기화
- **검증 조건**: GameController 객체 생성 성공
- **Pass 기준**:
  - 객체가 정상적으로 생성됨
  - pyautogui 사용 가능
- **Fail 기준**:
  - ImportError 또는 초기화 예외 발생

#### 1.3 템플릿 이미지 존재 확인
- **검증 조건**: 필수 템플릿 파일 존재 여부
- **검증 대상**:
  - `deploy_button.png`
  - `start_tile.png`
  - `formation_screen.png`
- **Pass 기준**:
  - 모든 템플릿 파일이 존재함
  - 파일 크기 > 0
- **Fail 기준**:
  - 템플릿 파일 1개 이상 누락
  - 파일이 손상되었거나 읽을 수 없음

#### 1.4 TestLogger 기능
- **검증 조건**: 로그 생성 및 저장 기능
- **Pass 기준**:
  - 로그 디렉토리 생성 성공
  - 검증 결과 기록 가능
- **Fail 기준**:
  - 디렉토리 생성 실패
  - 권한 오류 발생

### 종합 판정
- **Pass**: 모든 검증 항목 통과
- **Fail**: 1개 이상 항목 실패

---

## TC-002: 단계 1-2.5 스테이지 진입

### 목적
게임 시작부터 임무 개시까지의 일련의 단계를 검증합니다.

### 사전 조건
- 게임 실행 상태
- Normal 1-4 스테이지 화면 (맵 선택 화면)

### 검증 항목

#### 2.1 시작 발판 → 편성 화면
- **검증 조건 (다중)**:
  1. `start_tile.png` 템플릿 매칭 (신뢰도 ≥ 0.8)
  2. 클릭 후 `formation_screen.png` 출현 (15초 이내)
  3. 화면 전환 확인 (start_tile 소멸)
- **Pass 기준**:
  - 3가지 조건 모두 충족
  - 편성 화면이 정상적으로 표시됨
- **Fail 기준**:
  - start_tile을 찾을 수 없음 (15초 타임아웃)
  - 클릭 후 formation_screen이 나타나지 않음 (15초 타임아웃)
  - 화면 전환 실패

#### 2.2 편성 화면 → 출격
- **검증 조건 (다중)**:
  1. `deploy_button.png` 템플릿 매칭 (신뢰도 ≥ 0.8)
  2. 클릭 후 `stage_map.png` 출현 (15초 이내)
  3. formation_screen 소멸 확인
- **Pass 기준**:
  - 3가지 조건 모두 충족
  - 스테이지 맵이 정상적으로 표시됨
- **Fail 기준**:
  - deploy_button을 찾을 수 없음
  - 클릭 후 stage_map이 나타나지 않음
  - 화면 전환 실패

#### 2.3 임무 개시
- **검증 조건 (다중)**:
  1. `mission_start_button.png` 템플릿 매칭 (신뢰도 ≥ 0.8)
  2. 버튼 클릭 성공
  3. stage_map 유지 확인 (버튼 소멸)
- **Pass 기준**:
  - mission_start_button 클릭 성공
  - 스테이지 맵이 유지되고 버튼만 사라짐
- **Fail 기준**:
  - mission_start_button을 찾을 수 없음
  - 클릭 후 예상치 못한 화면 전환

### 종합 판정
- **Pass**: 모든 단계(2.1, 2.2, 2.3) 통과
- **Fail**: 1개 이상 단계 실패 시 즉시 중단 및 Fail

---

## TC-003: 단계 3 발판 이동

### 목적
스테이지 내 발판 클릭 및 이동 기능을 검증합니다.

### 사전 조건
- TC-002 성공 (스테이지 맵 화면)
- 임무 개시 완료

### 검증 항목

#### 3.1 발판 인식 (적 우선)
- **검증 조건 (우선순위)**:
  1. `enemy_tile.png` 템플릿 매칭 (신뢰도 ≥ 0.5)
  2. 없으면 `empty_tile.png` 탐색 (신뢰도 ≥ 0.5)
- **Pass 기준**:
  - enemy_tile 또는 empty_tile 중 1개 이상 인식
- **Fail 기준**:
  - 두 템플릿 모두 인식 실패 (10초 타임아웃)

#### 3.2 발판 클릭
- **검증 조건**:
  1. 인식된 발판 좌표로 클릭 수행
  2. 클릭 후 반응 확인
- **Pass 기준**:
  - 클릭 수행 완료
  - 오류 없음
- **Fail 기준**:
  - 클릭 좌표 계산 오류
  - pyautogui 예외 발생

#### 3.3 전투 진입 또는 Phase 종료
- **검증 조건 (발판 타입별)**:
  - **적 발판인 경우**:
    1. `battle_ui.png` 출현 (10초 이내)
    2. 스테이지 맵 소멸 확인
  - **빈 발판인 경우**:
    1. `phase_end_button.png` 출현 (5초 이내)
    2. 버튼 클릭 후 3초 대기
    3. `stage_map.png` 소멸 여부 확인 (전투 진입 여부)
- **Pass 기준**:
  - 발판 타입에 따른 적절한 화면 전환 확인
- **Fail 기준**:
  - 예상 UI가 나타나지 않음
  - 화면 전환 없음

### 종합 판정
- **Pass**: 모든 검증 항목 통과
- **Fail**: 1개 이상 항목 실패

---

## TC-004: 스킬 코스트 OCR 테스트

### 목적
전투 중 OCR을 사용한 코스트 인식 기능을 검증합니다.

### 사전 조건
- 전투 화면 진입 완료 (battle_ui 표시)
- Tesseract OCR 설치 완료

### 검증 항목

#### 4.1 OCR 초기화
- **검증 조건**:
  1. OCRReader 객체 생성 성공
  2. Tesseract 실행 파일 존재 확인
  3. 언어팩(eng) 로드 확인
- **Pass 기준**:
  - OCRReader 정상 초기화
  - Tesseract 사용 가능
- **Fail 기준**:
  - Tesseract 미설치
  - 언어팩 누락
  - 초기화 예외 발생

#### 4.2 현재 코스트 읽기
- **검증 조건**:
  1. 현재 코스트 UI 영역 캡처 (config/ocr_regions.py 좌표)
  2. OCR로 숫자 읽기 (0-10 범위)
  3. 유효한 정수값 반환
- **Pass 기준**:
  - 0-10 범위의 정수값 읽기 성공
  - 재시도 로직 정상 작동 (최대 5회)
- **Fail 기준**:
  - OCR 읽기 실패 (None 반환)
  - 범위 외 값 반환
  - 타임아웃 (5초)

#### 4.3 스킬 버튼 코스트 읽기 (3개 슬롯)
- **검증 조건**:
  1. 각 스킬 슬롯(1, 2, 3) 코스트 영역 캡처
  2. OCR로 각 슬롯 코스트 읽기 (1-10 범위)
  3. 최소 1개 이상 읽기 성공
- **Pass 기준**:
  - 3개 슬롯 중 1개 이상 코스트 읽기 성공
  - 읽은 값이 유효 범위(1-10) 내
- **Fail 기준**:
  - 모든 슬롯 읽기 실패
  - 유효하지 않은 값

### 종합 판정
- **Pass**: 현재 코스트 + 스킬 버튼 코스트 1개 이상 읽기 성공
- **Fail**: 필수 항목 읽기 실패

---

## TC-005: 스킬 사용 시스템 테스트

### 목적
스킬 사용 및 코스트 소모 검증 시스템을 테스트합니다.

### 사전 조건
- TC-004 성공 (OCR 정상 동작)
- 전투 화면에서 코스트 ≥ 2

### 검증 항목

#### 5.1 단일 스킬 사용
- **검증 조건 (다중)**:
  1. 스킬 버튼 코스트 읽기 (예: 2코스트)
  2. 현재 코스트 읽기 (사용 전)
  3. 코스트 충분 여부 확인
  4. 스킬 버튼 → 화면 중앙 드래그 (0.5초)
  5. 1초 대기 (코스트 UI 업데이트)
  6. 현재 코스트 읽기 (사용 후)
  7. 코스트 차감 검증: (사용 전 - 사용 후) == 스킬 코스트
- **Pass 기준**:
  - 코스트가 정확히 차감됨
  - 스킬 사용 애니메이션 확인 (화면 중앙 이펙트)
- **Fail 기준**:
  - 코스트 차감 불일치
  - 스킬 미발동 (코스트 변화 없음)
  - OCR 읽기 실패

#### 5.2 코스트 부족 시나리오
- **검증 조건**:
  1. 현재 코스트 < 스킬 코스트 상태 만들기
  2. 스킬 사용 시도
  3. 코스트 변화 없음 확인
- **Pass 기준**:
  - 스킬 미발동
  - 코스트 변화 없음
  - 예외 발생 없음
- **Fail 기준**:
  - 코스트 부족해도 차감됨
  - 예외 발생

#### 5.3 다중 스킬 사용 (선택사항)
- **검증 조건**:
  1. 3개 스킬 연속 사용
  2. 각 스킬마다 코스트 검증
- **Pass 기준**:
  - 각 스킬의 코스트가 순차적으로 정확히 차감됨
- **Fail 기준**:
  - 1개 이상 스킬의 코스트 검증 실패

### 종합 판정
- **Pass**: 단일 스킬 사용(5.1) + 코스트 부족(5.2) 통과
- **Fail**: 필수 항목 중 1개 이상 실패

---

## TC-006: 단계 6 전투 결과 확인

### 목적
전투 종료 후 결과 확인 및 스테이지 복귀 과정을 검증합니다.

### 사전 조건
- 전투 종료 (Victory 화면)

### 검증 항목

#### 6.1 전투 종료 확인
- **검증 조건 (다중)**:
  1. `victory.png` 템플릿 매칭 (120초 이내)
  2. battle_ui 소멸 확인
  3. victory 화면 안정화 (2초 대기)
- **Pass 기준**:
  - victory 화면 출현
  - 전투 UI 사라짐
- **Fail 기준**:
  - 120초 내 victory 미출현 (전투 실패 또는 무한 전투)
  - 화면 전환 실패

#### 6.2 통계 버튼 → 데미지 기록
- **검증 조건 (순차)**:
  1. `battle_log_button.png` 클릭
  2. `damage_report.png` 출현 (5초 이내)
  3. 3초 대기 (데미지 확인 시간)
  4. `damage_report_close_button.png` 클릭
  5. damage_report 소멸 확인
- **Pass 기준**:
  - 데미지 기록 창 정상 출현 및 닫기
  - 각 단계 오류 없음
- **Fail 기준**:
  - 버튼 인식 실패
  - 팝업 출현/소멸 실패

#### 6.3 Victory 확인 → 랭크 획득
- **검증 조건 (순차)**:
  1. `victory_confirm.png` 클릭
  2. `rank_reward.png` 출현 (5초 이내)
  3. `rank_reward_confirm_button.png` 클릭
  4. rank_reward 소멸 확인
- **Pass 기준**:
  - 랭크 획득 창 정상 출현 및 닫기
- **Fail 기준**:
  - 버튼 인식 실패
  - 팝업 처리 실패

#### 6.4 스테이지 복귀
- **검증 조건 (다중)**:
  1. `stage_map.png` 또는 `stage_map_2.png` 출현 (10초 이내)
  2. victory 관련 UI 모두 소멸
  3. 스테이지 선택 화면으로 복귀
- **Pass 기준**:
  - 스테이지 맵 화면 복귀 확인
  - 모든 팝업 정리됨
- **Fail 기준**:
  - 스테이지 복귀 실패
  - UI가 남아있음

### 종합 판정
- **Pass**: 모든 단계(6.1-6.4) 순차 통과
- **Fail**: 1개 이상 단계 실패 시 즉시 중단 및 Fail

---

## TC-007: 전체 플로우 실행

### 목적
Normal 1-4 스테이지 전체 자동 플레이를 검증합니다.

### 사전 조건
- 게임 실행 상태
- Normal 1-4 스테이지 선택 화면

### 검증 항목
- TC-002 (스테이지 진입)
- TC-003 (발판 이동)
- 전투 진입 확인
- 전투 중 대기 (120초 이내 종료)
- TC-006 (전투 결과 확인)

### 종합 판정
- **Pass**: 모든 단계 통과 + 스테이지 복귀
- **Fail**: 중간 단계 실패 시 즉시 중단

### 예상 실행 시간
- **정상**: 3-5분
- **최대**: 10분 (전투 지연 시)

---

## 다중 조건 검증 전략

### 전투 진입 여부 판단
단일 템플릿이 아닌 **3가지 요소**를 동시 확인:
1. `battle_ui.png` 템플릿 매칭 (신뢰도 ≥ 0.8)
2. 스킬 버튼 1개 이상 인식 (템플릿 또는 OCR)
3. 코스트 UI 인식 (OCR로 0-10 읽기 성공)

**Pass**: 3가지 중 2가지 이상 충족
**Fail**: 1가지 이하만 충족

### 전투 종료 여부 판단
1. `victory.png` 템플릿 매칭
2. battle_ui 소멸 확인
3. victory 관련 버튼 출현 (`victory_confirm.png`)

**Pass**: 3가지 모두 충족
**Fail**: 1가지 이상 미충족

### 화면 전환 확인
1. 이전 화면 UI 소멸
2. 새 화면 UI 출현
3. 2초 안정화 대기 후 재확인

---

## 로그 및 스크린샷

### 자동 저장 항목
- 각 단계별 스크린샷 (`logs/YYYYMMDD_HHMMSS/`)
- 검증 결과 JSON 파일 (`result.json`)
- 실패 시 현재 화면 캡처 (`failure_screenshot.png`)

### result.json 구조
```json
{
  "test_name": "TC-002",
  "start_time": "2026-01-08 15:30:00",
  "end_time": "2026-01-08 15:30:45",
  "duration": 45,
  "status": "PASS",
  "steps": [
    {
      "step": "2.1",
      "description": "시작 발판 → 편성 화면",
      "conditions": [
        {"check": "start_tile 인식", "result": "PASS"},
        {"check": "formation_screen 출현", "result": "PASS"},
        {"check": "start_tile 소멸", "result": "PASS"}
      ],
      "status": "PASS"
    }
  ],
  "screenshots": [
    "step_2.1_before.png",
    "step_2.1_after.png"
  ]
}
```

---

## 테스트 실행 가이드

### 수동 실행
```bash
# 개별 테스트
python tests/test_partial_stage.py
python tests/test_skill_usage.py

# 전체 플로우
python tests/test_full_stage.py
```

### GUI 실행
```bash
# GUI 테스트 러너
python gui_test_runner.py

# 또는 빌드된 실행 파일
dist/BlueArchiveAutoTest.exe
```

### 체크박스 선택 실행 (GUI)
1. 원하는 테스트 항목 체크
2. "선택 항목 실행" 버튼 클릭
3. 의존성 미충족 항목은 자동 Block 처리

---

## 부록: 신뢰도 임계값

| 템플릿 | 신뢰도 | 비고 |
|--------|--------|------|
| deploy_button.png | 0.8 | 고정 UI |
| formation_screen.png | 0.8 | 고정 UI |
| stage_map.png | 0.8 | 고정 UI |
| battle_ui.png | 0.8 | 고정 UI |
| victory.png | 0.8 | 고정 UI |
| enemy_tile.png | 0.5 | 동적 요소 (낮은 신뢰도) |
| empty_tile.png | 0.5 | 동적 요소 (낮은 신뢰도) |
| skill_button | 0.7 | 캐릭터별 상이 |

---

## 문서 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2026-01-08 | 초안 작성 |
